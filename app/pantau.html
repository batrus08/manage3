<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pantau - Control Meowlie</title>
  <link rel="stylesheet" href="assets/bootstrap.min.css">
  <link rel="stylesheet" href="assets/styles.css">
  <link rel="stylesheet" href="assets/custom.css">
</head>
<body class="sb-nav-fixed">
<div id="header"></div>
<main class="container-fluid px-4 my-4">
  <div id="formCard" class="card mb-4 d-none">
    <div class="card-body">
      <form id="seatForm">
        <input type="hidden" id="seatId">
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Email</label>
            <input type="email" id="seatEmail" class="form-control" required>
          </div>
          <div class="col-md-2">
            <label class="form-label">Durasi (hari)</label>
            <input type="number" id="seatDur" class="form-control" value="1" min="1">
          </div>
          <div class="col-md-4">
            <label class="form-label">Mulai</label>
            <input type="datetime-local" id="seatStart" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="button" id="btnNow" class="btn btn-secondary w-100">Sekarang</button>
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-success me-2">Simpan</button>
          <button type="button" id="cancelForm" class="btn btn-secondary">Batal</button>
        </div>
      </form>
    </div>
  </div>
  <div class="card mb-4">
    <div class="card-header">Aktif (<span id="activeCount">0</span>)</div>
    <div class="card-body">
      <table class="table table-hover" id="activeTable">
        <thead><tr><th>Email</th><th>Akun Team</th><th>Mulai</th><th>Berakhir</th><th>Sisa Durasi</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="card mb-4">
    <div class="card-header">Expired (<span id="expiredCount">0</span>)</div>
    <div class="card-body">
      <table class="table table-hover" id="expiredTable">
        <thead><tr><th>Email</th><th>Akun Team</th><th>Mulai</th><th>Berakhir</th><th>Sisa Durasi</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>
<div id="footer"></div>
<script src="assets/bootstrap.bundle.min.js"></script>
<script src="assets/scripts.js"></script>
<script src="assets/main.js"></script>
<script>
let seats=[],teams=[],nameMap={};
function sisaHari(end){return Math.max(0,Math.ceil((new Date(end)-new Date())/86400000));}
async function loadData(){
  try{
    const [seatRes,teamRes]=await Promise.all([
      fetch('/api/seats'),
      fetch('/api/teams')
    ]);
    seats=await seatRes.json();
    teams=await teamRes.json();
    nameMap={};
    teams.forEach(t=>nameMap[t.id]=t.nama);
    render();
  }catch(e){alert('Gagal memuat seats');}
}
function render(){
  const aktif=seats.filter(s=>s.status!=='expired');
  const expired=seats.filter(s=>s.status==='expired');
  document.getElementById('activeCount').textContent=aktif.length;
  document.getElementById('expiredCount').textContent=expired.length;
  renderTable(aktif,document.querySelector('#activeTable tbody'));
  renderTable(expired,document.querySelector('#expiredTable tbody'));
}
function toLocalString(iso){
  const d=new Date(iso);
  return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
}
function renderTable(list,tbody){
  tbody.innerHTML='';
  list.forEach(s=>{
    const tr=document.createElement('tr');
    const sisa=sisaHari(s.berakhir);
    const start=toLocalString(s.mulai).replace('T',' ');
    const end=toLocalString(s.berakhir).replace('T',' ');
    tr.innerHTML=`<td>${s.email}</td><td>${nameMap[s.team_id]||s.team_id}</td><td>${start}</td><td>${end}</td><td>${sisa} hari</td><td><button class="btn btn-sm btn-secondary me-1 edit" data-id="${s.id}">Edit</button><button class="btn btn-sm btn-danger delete" data-id="${s.id}">Hapus</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('.edit').forEach(b=>b.addEventListener('click',()=>editSeat(b.dataset.id)));
  tbody.querySelectorAll('.delete').forEach(b=>b.addEventListener('click',()=>deleteSeat(b.dataset.id)));
}
function showForm(seat){
  document.getElementById('formCard').classList.remove('d-none');
  if(seat){
    document.getElementById('seatId').value=seat.id;
    document.getElementById('seatEmail').value=seat.email;
    document.getElementById('seatDur').value=Math.max(1,Math.ceil((new Date(seat.berakhir)-new Date(seat.mulai))/86400000));
    document.getElementById('seatStart').value=toLocalString(seat.mulai);
  }else{
    document.getElementById('seatId').value='';
    document.getElementById('seatForm').reset();
    document.getElementById('seatDur').value=1;
    setNow();
  }
}
function hideForm(){document.getElementById('formCard').classList.add('d-none');}
function setNow(){
  const now=new Date();
  const local=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16);
  document.getElementById('seatStart').value=local;
}
function editSeat(id){const seat=seats.find(s=>s.id==id);if(seat)showForm(seat);}
async function deleteSeat(id){
  if(!confirm('Hapus seat ini?')) return;
  const r=await fetch(`/api/seats/${id}`,{method:'DELETE'});
  if(r.ok) loadData(); else alert('Gagal menghapus');
}
async function saveSeat(ev){
  ev.preventDefault();
  const id=document.getElementById('seatId').value;
  const email=document.getElementById('seatEmail').value;
  const dur=parseInt(document.getElementById('seatDur').value);
  let mulai=document.getElementById('seatStart').value;
  if(!mulai){setNow();mulai=document.getElementById('seatStart').value;}
  const start=new Date(mulai);
  const end=new Date(start.getTime()+dur*86400000);
  if(end<=start){alert('Durasi tidak valid');return;}
  const payload={email,mulai:start.toISOString(),berakhir:end.toISOString()};
  const r=await fetch(`/api/seats/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(r.ok){hideForm();loadData();}else{const err=await r.json().catch(()=>({}));alert(err.error||'Gagal menyimpan');}
}
document.getElementById('seatForm').addEventListener('submit',saveSeat);
document.getElementById('cancelForm').addEventListener('click',hideForm);
document.getElementById('btnNow').addEventListener('click',setNow);
loadPartials().then(loadData);
</script>
  <script src="assets/data-tools.js"></script>
  <script src="assets/form-drafts.js"></script>
</body>
</html>